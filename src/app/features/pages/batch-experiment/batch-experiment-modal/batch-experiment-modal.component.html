<form [formGroup]="experimentForm" (ngSubmit)="onSubmit()">
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
    <div class="bg-white rounded-lg p-6 shadow-sm">
      <h2 class="text-lg font-semibold mb-6 text-gray-900">
        General information
      </h2>

      <div class="space-y-4">
        <div>
          <label
            for="batchId"
            class="block text-sm font-medium text-gray-700 mb-2"
          >
            Batch ID <span class="text-red-500">*</span>
          </label>
          <input
            pInputText
            id="batchId"
            formControlName="batchId"
            class="w-full"
            placeholder="R01/001"
            type="text"
          />
          @if (formControls['batchId'].invalid && (formControls['batchId'].dirty
          || formControls['batchId'].touched)) { @if
          (formControls['batchId'].errors?.['required']) {
          <small class="text-red-600">Batch ID is required.</small>
          } }
        </div>

        <div>
          <label
            for="operator"
            class="block text-sm font-medium text-gray-700 mb-2"
          >
            Operator <span class="text-red-500">*</span>
          </label>
          <input
            pInputText
            id="operator"
            formControlName="operator"
            class="w-full"
            placeholder="Enter operator name"
            type="text"
          />
          @if (formControls['operator'].invalid &&
          (formControls['operator'].dirty || formControls['operator'].touched))
          { @if (formControls['operator'].errors?.['required']) {
          <small class="text-red-600">Operator is required.</small>
          } }
        </div>

        <div>
          <label
            for="date"
            class="block text-sm font-medium text-gray-700 mb-2"
          >
            Date <span class="text-red-500">*</span>
          </label>
          <p-datepicker
            inputId="date"
            formControlName="date"
            [showIcon]="true"
            dateFormat="dd/mm/yy"
            placeholder="DD/MM/YYYY"
          ></p-datepicker>
          @if (formControls['date'].invalid && (formControls['date'].dirty ||
          formControls['date'].touched)) { @if
          (formControls['date'].errors?.['required']) {
          <small class="text-red-600">Date is required.</small>
          } }
        </div>

        <div>
          <label
            for="reactorId"
            class="block text-sm font-medium text-gray-700 mb-2"
          >
            Reactor ID <span class="text-red-500">*</span>
          </label>
          <p-select
            formControlName="reactorId"
            class="w-full"
            appendTo="body"
            optionLabel="name"
            optionValue="id"
            [options]="reactors.data() || []"
            placeholder="Select status"
            focusOnHover="true"
            checkmark="true"
          />
          @if (formControls['reactorId'].invalid &&
          (formControls['reactorId'].dirty ||
          formControls['reactorId'].touched)) { @if
          (formControls['reactorId'].errors?.['required']) {
          <small class="text-red-600">Reactor ID is required.</small>
          } }
        </div>

        <div>
          <label
            for="blockId"
            class="block text-sm font-medium text-gray-700 mb-2"
          >
            Block ID <span class="text-red-500">*</span>
          </label>
          <input
            pInputText
            id="blockId"
            formControlName="blockId"
            class="w-full"
            placeholder="B01/001"
            type="text"
          />
          @if (formControls['blockId'].invalid && (formControls['blockId'].dirty
          || formControls['blockId'].touched)) { @if
          (formControls['blockId'].errors?.['required']) {
          <small class="text-red-600">Block ID is required.</small>
          } }
        </div>

        <div class="flex flex-col gap-4">
          <div>
            <label
              for="timeStart"
              class="block text-sm font-medium text-gray-700 mb-2"
            >
              Time start <span class="text-red-500">*</span>
            </label>
            <p-datepicker
              id="timeStart"
              formControlName="timeStart"
              class="w-full"
              placeholder="14:30:30"
              type="time"
              [timeOnly]="true"
            />
            @if (formControls['timeStart'].invalid &&
            (formControls['timeStart'].dirty ||
            formControls['timeStart'].touched)) { @if
            (formControls['timeStart'].errors?.['required']) {
            <small class="text-red-600">Time start is required.</small>
            } }
          </div>

          <div>
            <label
              for="timeEnd"
              class="block text-sm font-medium text-gray-700 mb-2"
            >
              Time end <span class="text-red-500">*</span>
            </label>
            <p-datepicker
              id="timeEnd"
              formControlName="timeEnd"
              class="w-full"
              placeholder="14:35:00"
              [timeOnly]="true"
            />
            @if (formControls['timeEnd'].invalid &&
            (formControls['timeEnd'].dirty || formControls['timeEnd'].touched))
            { @if (formControls['timeEnd'].errors?.['required']) {
            <small class="text-red-600">Time end is required.</small>
            } }
          </div>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-lg p-6 shadow-sm">
      <h2 class="text-lg font-semibold mb-6 text-gray-900">
        Material feedstock
      </h2>

      <div class="space-y-4">
        <div>
          <label
            for="mixDesign"
            class="block text-sm font-medium text-gray-700 mb-2"
          >
            Mix design
          </label>
          <input
            pInputText
            id="mixDesign"
            formControlName="mixDesign"
            class="w-full"
            placeholder="1:2:3"
            type="text"
          />
        </div>

        <div>
          <label
            for="cement"
            class="block text-sm font-medium text-gray-700 mb-2"
          >
            Cement (kg)
          </label>
          <p-inputNumber
            inputId="cement"
            formControlName="cement"
            [minFractionDigits]="1"
            [maxFractionDigits]="2"
            placeholder="1.2"
            styleClass="w-full"
          ></p-inputNumber>
        </div>

        <div>
          <label
            for="fineAggregate"
            class="block text-sm font-medium text-gray-700 mb-2"
          >
            Fine Aggregate (kg)
          </label>
          <p-inputNumber
            inputId="fineAggregate"
            formControlName="fineAggregate"
            [minFractionDigits]="1"
            [maxFractionDigits]="2"
            placeholder="2.7"
            styleClass="w-full"
          ></p-inputNumber>
        </div>

        <div>
          <label
            for="coarseAggregate"
            class="block text-sm font-medium text-gray-700 mb-2"
          >
            Coarse Aggregate (kg)
          </label>
          <p-inputNumber
            inputId="coarseAggregate"
            formControlName="coarseAggregate"
            [minFractionDigits]="1"
            [maxFractionDigits]="2"
            placeholder="4.1"
            styleClass="w-full"
          ></p-inputNumber>
        </div>

        <div>
          <label
            for="water"
            class="block text-sm font-medium text-gray-700 mb-2"
          >
            Water
          </label>
          <p-inputNumber
            inputId="water"
            formControlName="water"
            [minFractionDigits]="1"
            [maxFractionDigits]="2"
            placeholder="0.6"
            styleClass="w-full"
          ></p-inputNumber>
        </div>

        <div>
          <label
            for="waterCementRatio"
            class="block text-sm font-medium text-gray-700 mb-2"
          >
            Water cement ratio
          </label>
          <p-inputNumber
            inputId="waterCementRatio"
            formControlName="waterCementRatio"
            [minFractionDigits]="2"
            [maxFractionDigits]="2"
            placeholder="0.55"
            styleClass="w-full"
          ></p-inputNumber>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Block size (mm)
          </label>
          <div class="flex w-3/4 items-center gap-2">
            <p-inputNumber
              formControlName="blockSizeLength"
              [showButtons]="true"
              buttonLayout="vertical"
              spinnerMode="vertical"
              [minFractionDigits]="0"
              [maxFractionDigits]="0"
              placeholder="150"
              class="w-1/4 mr-1"
              size="small"
            ></p-inputNumber>
            <span class="text-gray-500 text-xl">×</span>
            <p-inputNumber
              formControlName="blockSizeWidth"
              [showButtons]="true"
              buttonLayout="vertical"
              spinnerMode="vertical"
              [minFractionDigits]="0"
              [maxFractionDigits]="0"
              placeholder="150"
              class="w-1/4 mr-1"
              size="small"
            ></p-inputNumber>
            <span class="text-gray-500 text-xl">×</span>
            <p-inputNumber
              formControlName="blockSizeHeight"
              [showButtons]="true"
              buttonLayout="vertical"
              spinnerMode="vertical"
              [minFractionDigits]="0"
              [maxFractionDigits]="0"
              placeholder="150"
              class="w-1/4 mr-1"
              size="small"
            ></p-inputNumber>
          </div>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-lg p-6 shadow-sm">
      <h2 class="text-lg font-semibold mb-6 text-gray-900">
        Exposure conditions
      </h2>

      <div class="space-y-4">
        <div class="mb-4">
          <label
            for="reactorStatus"
            class="block text-sm font-medium text-gray-700 ml-2 mb-2"
          >
            Co2 Form
          </label>

          <p-select
            formControlName="co2Form"
            class="w-full"
            focusOnHover="true"
            appendTo="body"
            checkmark="true"
            showClear="true"
            [options]="co2Forms()"
            placeholder="Select CO2 form"
          />
        </div>
        <div>
          <label
            for="waterCementRatio"
            class="block text-sm font-medium text-gray-700 mb-2"
          >
            Co2 Mass
          </label>
          <p-inputNumber
            inputId="co2Mass"
            formControlName="co2Mass"
            [minFractionDigits]="2"
            [maxFractionDigits]="2"
            placeholder="Enter mass in Gramms"
            styleClass="w-full"
          ></p-inputNumber>
        </div>
        <div>
          <label
            for="waterCementRatio"
            class="block text-sm font-medium text-gray-700 mb-2"
          >
            Injection Pressure
          </label>
          <p-inputNumber
            inputId="injectionPressure"
            formControlName="injectionPressure"
            [minFractionDigits]="2"
            [maxFractionDigits]="2"
            placeholder="Enter pressure"
            styleClass="w-full"
          ></p-inputNumber>
        </div>
        <div>
          <label
            for="waterCementRatio"
            class="block text-sm font-medium text-gray-700 mb-2"
          >
            Head Space
          </label>
          <p-inputNumber
            inputId="headSpace"
            formControlName="headSpace"
            [minFractionDigits]="2"
            [maxFractionDigits]="2"
            placeholder="Enter head space"
            styleClass="w-full"
          ></p-inputNumber>
        </div>
        <div>
          <label
            for="waterCementRatio"
            class="block text-sm font-medium text-gray-700 mb-2"
          >
            Reaction Time
          </label>
          <p-inputNumber
            inputId="reactionTime"
            formControlName="reactionTime"
            [minFractionDigits]="2"
            [maxFractionDigits]="2"
            placeholder="Enter reaction time in seconds"
            styleClass="w-full"
          ></p-inputNumber>
        </div>
      </div>
    </div>

    <div class="bg-white rounded-lg p-6 shadow-sm col-span-1 lg:col-span-3">
      <h2 class="text-lg font-semibold mb-6 text-gray-900">Analytical Tests</h2>

      <div formArrayName="analyticalTests" class="space-y-4">
        @for (test of analyticalTests.controls; let i = $index; track test) {
        <div [formGroupName]="i" class="p-4 border border-gray-300 rounded-lg">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Name
              </label>
              <div class="flex items-center gap-2">
                <label
                  for=""
                  class="block text-sm font-bold text-gray-700 mb-2"
                >
                  {{ i + 1 }}.
                </label>
                <input
                  pInputText
                  formControlName="name"
                  class="w-full"
                  placeholder="e.g., TGA, XRD"
                  type="text"
                />
              </div>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Sample ID
              </label>
              <input
                pInputText
                formControlName="sampleId"
                class="w-full"
                placeholder="Enter sample ID"
                type="text"
              />
            </div>

            <div>
              <label
                for="date"
                class="block text-sm font-medium text-gray-700 mb-2"
              >
                Date
              </label>
              <p-datepicker
                inputId="date"
                formControlName="date"
                [showIcon]="true"
                dateFormat="dd/mm/yy"
                placeholder="DD/MM/YYYY"
              ></p-datepicker>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">
                Upload File
              </label>

              @if (uploadingFiles().get(i)) {
              <div class="flex items-center gap-2">
                <p-progress-spinner
                  strokeWidth="4"
                  fill="transparent"
                  animationDuration=".5s"
                  [style]="{ width: '30px', height: '30px' }"
                />
                <span class="text-sm text-gray-600">Uploading...</span>
              </div>
              } @else if (analyticalTests.at(i).value.pdfUrl) {
              <div class="flex items-center gap-2">
                <a
                  [href]="analyticalTests.at(i).value.pdfUrl"
                  target="_blank"
                  class="text-blue-600 hover:text-blue-800 underline text-sm flex items-center gap-1"
                >
                  <i class="pi pi-file-pdf"></i>
                  View PDF
                </a>
                @if (!readonly()) {
                <button
                  pButton
                  type="button"
                  icon="pi pi-times"
                  class="p-button-text p-button-sm p-button-danger"
                  (click)="removeFile(analyticalTests.at(i).value.pdfUrl, i)"
                ></button>
                }
              </div>
              } @else {
              <p-fileUpload
                mode="basic"
                name="file"
                chooseLabel="Choose File"
                accept=".pdf"
                maxFileSize="1000000"
                (onSelect)="onFileSelect($event, i)"
                [disabled]="readonly()"
              >
              </p-fileUpload>
              }
            </div>
          </div>

          <div class="mt-3 text-right">
            @if(!readonly()){
            <button
              pButton
              type="button"
              label="Remove"
              class="p-button-danger p-button-sm"
              (click)="removeAnalyticalTest(i)"
            ></button>
            }
          </div>
        </div>
        }
      </div>

      @if(!readonly()){
      <button
        pButton
        type="button"
        label="Add Analytical Test"
        icon="pi pi-plus"
        class="mt-4"
        (click)="addAnalyticalTest()"
      ></button>
      }
    </div>
  </div>

  <div class="flex justify-end gap-4 bg-white rounded-lg p-6 shadow-sm">
    @if (!readonly()) {
    <p-button
      label="Submit"
      type="submit"
      [disabled]="experimentForm.invalid"
      [loading]="loading()"
    ></p-button>
    }
  </div>
</form>
